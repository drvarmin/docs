# On open PR with docs content or app changes, deploy to docs staging

name: Deploy Docs to Staging on PR

on:
  pull_request:
    types: [opened, synchronize]
    paths:
      - "src/**"
      - "content/**"
      - "scripts/**"
      - "package.json"
      - "next.config.ts"

concurrency:
  group: docs-staging-${{ github.head_ref }}
  cancel-in-progress: true

jobs:
  deploy_docs_staging:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      deployments: write
      issues: write
      pull-requests: write
    env:
      # Depot Turbo Cache Configuration
      TURBO_API: https://cache.depot.dev
      TURBO_TOKEN: ${{ secrets.DEPOT_TOKEN }}
      TURBO_TEAM: ${{ secrets.DEPOT_ORG_ID }}
      # Cloudflare configuration
      CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
      CF_ACCOUNT_ID: ${{ secrets.CF_ACCOUNT_ID }}
      CF_STAGING_WORKER_NAME: ${{ secrets.CF_STAGING_WORKER_NAME }}
      DOCS_SLACK_FEEDBACK_WEBHOOK: ${{ secrets.DOCS_SLACK_FEEDBACK_WEBHOOK }}
      DOCS_NEXT_PUBLIC_MESH_SDK_KEY: ${{ secrets.DOCS_NEXT_PUBLIC_MESH_SDK_KEY }}
      DOCS_NEXT_PUBLIC_UNIFY_SCRIPT_SRC: ${{ secrets.DOCS_NEXT_PUBLIC_UNIFY_SCRIPT_SRC }}
      DOCS_NEXT_PUBLIC_UNIFY_API_KEY: ${{ secrets.DOCS_NEXT_PUBLIC_UNIFY_API_KEY }}
      DOCS_NEXT_PUBLIC_RB2B_KEY: ${{ secrets.DOCS_NEXT_PUBLIC_RB2B_KEY }}
    steps:
      - uses: actions/checkout@v4
        with:
          submodules: true

      - name: Use Node.js 20.x
        uses: actions/setup-node@v4
        with:
          node-version: 20.18.1

      - name: Enable Corepack
        run: corepack enable

      - name: Install dependencies
        run: yarn install

      - name: Generate production env file
        run: |
          cat <<EOF > .env.production
          NEXTJS_ENV=production
          SLACK_FEEDBACK_WEBHOOK=${DOCS_SLACK_FEEDBACK_WEBHOOK}
          NEXT_PUBLIC_MESH_SDK_KEY=${DOCS_NEXT_PUBLIC_MESH_SDK_KEY}
          NEXT_PUBLIC_UNIFY_SCRIPT_SRC=${DOCS_NEXT_PUBLIC_UNIFY_SCRIPT_SRC}
          NEXT_PUBLIC_UNIFY_API_KEY=${DOCS_NEXT_PUBLIC_UNIFY_API_KEY}
          NEXT_PUBLIC_RB2B_KEY=${DOCS_NEXT_PUBLIC_RB2B_KEY}
          EOF

      - name: Generate Wrangler config for CI
        run: |
          cat <<EOF > wrangler.jsonc
          {
            "$schema": "node_modules/wrangler/config-schema.json",
            "account_id": "${CF_ACCOUNT_ID}",
            "main": ".open-next/worker.js",
            "name": "${CF_STAGING_WORKER_NAME}",
            "compatibility_date": "2024-12-30",
            "compatibility_flags": [
              "nodejs_compat",
              "global_fetch_strictly_public"
            ],
            "assets": {
              "directory": ".open-next/assets",
              "binding": "ASSETS"
            },
            "services": [{
              "binding": "WORKER_SELF_REFERENCE",
              "service": "${CF_STAGING_WORKER_NAME}"
            }],
            "routes": [],
            "env": {
              "staging": {
                "workers_dev": true,
                "routes": []
              }
            }
          }
          EOF


      - name: Build docs
        run: yarn build:prep && opennextjs-cloudflare build --config wrangler.jsonc

      - name: Upload Worker version with PR alias
        id: upload
        uses: cloudflare/wrangler-action@v3
        with:
          apiToken: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          accountId: ${{ secrets.CF_ACCOUNT_ID }}
          wranglerVersion: "4.25.0"
          workingDirectory: .
          command: --config wrangler.jsonc --env staging versions upload --name ${{ secrets.CF_STAGING_WORKER_NAME }} --preview-alias pr-${{ github.event.pull_request.number }}

      - name: Capture preview URLs
        id: parse
        env:
          CMD: ${{ steps.upload.outputs.command-output }}
        run: |
          echo "Wrangler output:"
          echo "$CMD"

          # Extract Version ID
          version_id=$(echo "$CMD" | sed -n 's/.*Version ID: \([A-Za-z0-9-]\+\).*/\1/p' | head -1)

          # Extract immutable Version Preview URL (pinned to this build)
          pinned_url=$(echo "$CMD" | sed -n 's/.*Version Preview URL: \(https:\/\/[^ ]*\).*/\1/p' | head -1)

          # Extract Alias URL (moves with commits to the PR)
          alias_url=$(echo "$CMD" | sed -n 's/.*Version Preview Alias URL: \(https:\/\/[^ ]*\).*/\1/p' | head -1)

          # Fallbacks if parsing fails
          if [ -z "$alias_url" ]; then
            alias_url="https://pr-${{ github.event.pull_request.number }}-${CF_STAGING_WORKER_NAME}.${{ secrets.CF_WORKERS_SUBDOMAIN }}.workers.dev"
          fi

          echo "version_id=$version_id" >> $GITHUB_OUTPUT
          echo "pinned_url=$pinned_url" >> $GITHUB_OUTPUT
          echo "alias_url=$alias_url" >> $GITHUB_OUTPUT

      - name: Comment PR with deployment URLs
        uses: actions/github-script@v7
        with:
          script: |
            const aliasUrl   = '${{ steps.parse.outputs.alias_url }}';
            const pinnedUrl  = '${{ steps.parse.outputs.pinned_url }}';
            const versionId  = '${{ steps.parse.outputs.version_id }}';
            const prNumber   = '${{ github.event.pull_request.number }}';
            const commitSha  = context.sha.substring(0, 7);

            let body = `ðŸ“š **Docs Preview Deployment**\n(updates with commits to the PR)\n`;
            if (aliasUrl)  body += `${aliasUrl}/home\n`;
            else if (pinnedUrl) body += `${pinnedUrl}/home\n`;
            else body += `No preview URL found\n`;
            body += `*Updated at ${new Date().toISOString()}, commit sha \`${commitSha}\`*`;

            const { data: comments } = await github.rest.issues.listComments({
              issue_number: context.issue.number, owner: context.repo.owner, repo: context.repo.repo
            });
            const prev = comments.find(c => c.user.type === 'Bot' && c.body.includes('Docs Preview Deployment'));
            if (prev) {
              await github.rest.issues.updateComment({ owner: context.repo.owner, repo: context.repo.repo, comment_id: prev.id, body });
            } else {
              await github.rest.issues.createComment({ issue_number: context.issue.number, owner: context.repo.owner, repo: context.repo.repo, body });
            }
